# Copyright (c) 2012 Tresys Technology LLC, Columbia, Maryland, USA
#
# This software was developed by Tresys Technology LLC
# with U.S. Government sponsorship.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set_sysctl_param() {
	PARAM=$1
	DESIRED=$2

	MODULE=`echo $PARAM|sed -e "s/\./\//g"`
	
	if `echo $PARAM| grep -r "ipv6" && grep -r "options\s+ipv6\s+disable\=1" /etc/modprobe.d`; then
		return 0
	fi

	[ -f /proc/sys/$MODULE ] || return 0
	[ -f /etc/sysctl.conf ] || return 1

	if `grep -q "${PARAM}" /etc/sysctl.conf`; then
		sysctl -q -p
	else
		echo ""                                 >> /etc/sysctl.conf &&
		echo "# Added by $(basename $0) on $(date -u)" >> /etc/sysctl.conf &&
		echo "$PARAM = $DESIRED"                       >> /etc/sysctl.conf
	fi

	if `sysctl -q -w $PARAM=$DESIRED`; then
		: # do nothing
	else
                echo "sysctl -w $PARAM=$DESIRED failed"
        fi

	. $(dirname $0)/set_general_entry
	safe_add_field "($PARAM = ).*" "$DESIRED" /etc/sysctl.conf
}
