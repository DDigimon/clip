# Copyright (c) 2012 Tresys Technology LLC, Columbia, Maryland, USA
#
# This software was developed by Tresys Technology LLC
# with U.S. Government sponsorship.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

SYSTEM_AUTH=/etc/pam.d/system-auth

set_pam_cracklib_option() {
	OPTION=$1
	DESIRED=$2

	if `grep -Pq "^password\s+requisite\s+pam_cracklib.so\s+.*$OPTION=$DESIRED\b" $SYSTEM_AUTH`; then
		exit 0
	else
		sed -i -r -e "s/^(password\s+requisite\s+pam_cracklib\.so.*)\s+$OPTION=[^\s]*\s*(.*$)/\1 \2/" $SYSTEM_AUTH
		sed -i -r -e "s/^(password\s+requisite\s+pam_cracklib\.so.*)\s+$/\1/" $SYSTEM_AUTH
		sed -i -r -e "s/^(password\s+requisite\s+pam_cracklib\.so\s+.*)/\1 $OPTION=$DESIRED/" $SYSTEM_AUTH
	fi
}

set_pam_unix_option() {
	OPTION=$1
	DESIRED=$2

	if `grep -Pq "^password\s+(?:sufficient|required)\s+pam_unix\.so\s+.*$OPTION=$DESIRED\b" $SYSTEM_AUTH`; then
		exit 0
	else
		sed -i -r -e "s/^(password\s+(sufficient|required)\s+pam_unix\.so.*)\s+$OPTION=[^\s]*\s*(.*$)/\1 \3/" $SYSTEM_AUTH
		sed -i -r -e "s/^(password\s+(sufficient|required)\s+pam_unix\.so.*)\s+$/\1/" $SYSTEM_AUTH
		sed -i -r -e "s/^(password\s+(sufficient|required)\s+pam_unix\.so\s+.*)/\1 $OPTION=$DESIRED/" $SYSTEM_AUTH
	fi
}

set_pam_unix_flag() {
	OPTION=$1

	if `grep -Pq "^password\s+(?:sufficient|required)\s+pam_unix\.so\s+.*$OPTION\b" $SYSTEM_AUTH`; then
		exit 0
	else
		sed -i -r -e "s/^(password\s+(sufficient|required)\s+pam_unix\.so\s+.*)/\1 $OPTION/" $SYSTEM_AUTH
	fi
}
